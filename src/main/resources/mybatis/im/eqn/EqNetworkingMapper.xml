<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qtech.im.eqn.mapper.EqNetworkingMapper">
    <resultMap id="qtechImCommonInfoResult" type="ImEqsAndNetCntVo">
        <result property="factoryName" column="company_name" />
        <result property="deptName" column="dep_name" />
        <result property="groupName" column="group_name" />
        <result property="deviceType" column="device_type" />
        <result property="eqId" column="device_m_id" />
        <result property="mcId" column="machine_no" />
        <result property="simId" column="pbox_id" />
        <result property="ttlEqs" column="ttl_eqs" />
        <result property="onlineEqs" column="online_eqs" />
        <result property="offlineEqs" column="offline_eqs" />
        <result property="netStatus" column="net_status" />
        <result property="remoteCode" column="Remote_control" />
        <result property="remoteStatus" column="remote_status" />
        <result property="dt" column="receive_date" />
    </resultMap>

    <select id="selectEqNetworkingOfflineList" parameterType="map" resultMap="qtechImCommonInfoResult">
        WITH _eq_net_ok_tb AS (
            SELECT
                device_id,
                Remote_control
            FROM
                QT_MODEL_DDC.ALL_DEVICE_REMOTE_CONTROL_DETAIL
            WHERE receive_date > minutes_sub(now(), 5)
        ),

        _eq_ttl_tb AS (
            SELECT
                b.company_name,
                b.dep_name,
                b.group_name,
                a.device_id,
                a.device_m_id,
                a.devicetype,
                a.machine_no,
                c.pbox_id,
                e.recieve_date
            FROM QT_MODEL_EMS.T_DEVICE_CALCGD1JH1U82GWWIONK a
            LEFT JOIN QT_MODEL_EMS.V_CODE_NAME b ON a.hierarchy_code = b.hierarchy_show_code
            LEFT JOIN QT_MODEL_EMS.T_PBOX_INFO c ON a.device_id = c.dev_id
            LEFT JOIN QT_MODEL_EMS.T_COLLECTOR_PROGRAM d ON c.collector_program_id = d.id
            LEFT JOIN QT_MODEL_DDC.ALL_DEVICE_REMOTE_CONTROL_DETAIL e ON a.device_id = e.device_id
            <where>
                AND b.dep_name IN
                <foreach item="item" index="index" collection="deptNames" open="(" separator="," close=")">
                    #{item}
                </foreach>
                <choose>
                    <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType != null and imEqsNetworkingAndRemoteInfoVo.deviceType != ''">
                        and devicetype = #{imEqsNetworkingAndRemoteInfoVo.deviceType}
                    </when>
                    <otherwise>
                        and devicetype in
                        <foreach item="item" index="index" collection="deviceTypes" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </where>
        ),

        _eq_ttl_net_info_tb AS (
            SELECT
                company_name,
                dep_name,
                group_name,
                devicetype,
                device_m_id,
                machine_no,
                pbox_id,
                receive_date,
                Remote_control,
                net_status,
                CASE
                    WHEN (Remote_control REGEXP '^-?[0-9]+(\.[0-9]+)?$' AND net_status = 1 AND ((devicetype IN ('AA', 'DB', 'HM') AND Remote_control = '2')
                        OR (devicetype = 'WB' AND Remote_control = '5'))) THEN 1
                    WHEN (Remote_control REGEXP '^-?[0-9]+(\.[0-9]+)?$' AND net_status = 1 AND Remote_control = '999') THEN -1
                    ELSE 0
                END remote_status
            FROM (
                SELECT
                    a.company_name,
                    a.dep_name,
                    a.group_name,
                    a.devicetype,
                    a.device_m_id,
                    a.machine_no,
                    a.pbox_id,
                    a.receive_date,
                    b.Remote_control,
                    CASE
                        WHEN b.Remote_control IS NULL THEN 0
                        ELSE 1
                    END AS net_status
                FROM _eq_ttl_tb a
                LEFT JOIN _eq_net_ok_tb b ON a.device_id = b.device_id
            ) a
        )

        SELECT
            company_name,
            dep_name,
            group_name,
            devicetype as device_type,
            device_m_id,
            machine_no,
            pbox_id,
            recieve_date,
            Remote_control,
            net_status,
            remote_status
        FROM _eq_ttl_net_info_tb
        <where>
            net_status = 0
            <if test="imEqsNetworkingAndRemoteInfoVo.factoryName != null and imEqsNetworkingAndRemoteInfoVo.factoryName != ''"> and company_name = #{imEqsNetworkingAndRemoteInfoVo.factoryName}</if>
            <if test="imEqsNetworkingAndRemoteInfoVo.groupName != null and imEqsNetworkingAndRemoteInfoVo.groupName != ''"> and group_name = #{imEqsNetworkingAndRemoteInfoVo.groupName}</if>
            <if test="imEqsNetworkingAndRemoteInfoVo.deviceType != null and imEqsNetworkingAndRemoteInfoVo.deviceType != ''"> and devicetype = #{imEqsNetworkingAndRemoteInfoVo.deviceType}</if>
        </where>
        ORDER BY
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.companyOrder" />,
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.groupOrder" />,
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.deviceTypeOrder" />,
            machine_no
    </select>

    <select id="selectEqNetworkingAgg" parameterType="map" resultMap="qtechImCommonInfoResult">
        WITH _eq_net_ok_tb AS (
            SELECT
                device_id,
                Remote_control
            FROM
                QT_MODEL_DDC.ALL_DEVICE_REMOTE_CONTROL_DETAIL
            WHERE receive_date > minutes_sub(now(), 5)
        ),

        _eq_ttl_tb AS (
            SELECT
                b.company_name,
                b.dep_name,
                b.group_name,
                a.device_id,
                a.device_m_id,
                a.devicetype,
                a.machine_no,
                c.pbox_id,
                e.receive_date
            FROM QT_MODEL_EMS.T_DEVICE_CALCGD1JH1U82GWWIONK a
            LEFT JOIN QT_MODEL_EMS.V_CODE_NAME b ON a.hierarchy_code = b.hierarchy_show_code
            LEFT JOIN QT_MODEL_EMS.T_PBOX_INFO c ON a.device_id = c.dev_id
            LEFT JOIN QT_MODEL_EMS.T_COLLECTOR_PROGRAM d ON c.collector_program_id = d.id
            LEFT JOIN QT_MODEL_DDC.ALL_DEVICE_REMOTE_CONTROL_DETAIL e ON a.device_id = e.device_id
            <where>
                AND b.dep_name IN
                <foreach item="item" index="index" collection="deptNames" open="(" separator="," close=")">
                    #{item}
                </foreach>
                <choose>
                    <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType != null and imEqsNetworkingAndRemoteInfoVo.deviceType != ''">
                        and devicetype = #{imEqsNetworkingAndRemoteInfoVo.deviceType}
                    </when>
                    <otherwise>
                        and devicetype in
                        <foreach item="item" index="index" collection="deviceTypes" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </otherwise>
                </choose>
            </where>
        ),

        _eq_ttl_net_info_tb AS (
            SELECT
                company_name,
                dep_name,
                group_name,
                devicetype,
                device_m_id,
                machine_no,
                pbox_id,
                receive_date,
                Remote_control,
                net_status,
                CASE
                    WHEN (Remote_control REGEXP '^-?[0-9]+(\.[0-9]+)?$' AND net_status = 1 AND ((devicetype IN ('AA', 'DB', 'HM') AND Remote_control = '2')
                        OR (devicetype = 'WB' AND Remote_control = '5'))) THEN 1
                    WHEN (Remote_control REGEXP '^-?[0-9]+(\.[0-9]+)?$' AND net_status = 1 AND Remote_control = '999') THEN -1
                    ELSE 0
                END remote_status
            FROM (
                SELECT
                    a.company_name,
                    a.dep_name,
                    a.group_name,
                    a.devicetype,
                    a.device_m_id,
                    a.machine_no,
                    a.pbox_id,
                    a.receive_date,
                    b.Remote_control,
                    CASE
                        WHEN b.Remote_control IS NULL THEN 0
                        ELSE 1
                    END AS net_status
                FROM _eq_ttl_tb a
                LEFT JOIN _eq_net_ok_tb b ON a.device_id = b.device_id
            ) a
        ),

        _eq_offline_info_group_tb AS (
            select
                case
                    when a.company_name is null then '总计'
                    else a.company_name
                end as company_name,
                case
                    when a.group_name is null then '小计'
                    else a.group_name
                end as group_name,
                <choose>
                    <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType == null or imEqsNetworkingAndRemoteInfoVo.deviceType == ''">
                        case
                            when a.devicetype is null then '小计'
                            else a.devicetype
                        end as devicetype,
                    </when>
                </choose>
                count(1) offline_eqs
            from
                _eq_ttl_net_info_tb a
            where
                net_status = 0
            group by
                <choose>
                    <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType != null and imEqsNetworkingAndRemoteInfoVo.deviceType != ''">
                        rollup (a.company_name, a.group_name)
                    </when>
                    <otherwise>
                        rollup (a.company_name, a.group_name, a.devicetype)
                    </otherwise>
                </choose>
        ),

        _eq_ttl_info_group_tb AS (
            select
                case
                    when a.company_name is null then '总计'
                    else a.company_name
                end as company_name,
                case
                    when a.group_name is null then '小计'
                    else a.group_name
                end as group_name,
                <choose>
                    <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType == null or imEqsNetworkingAndRemoteInfoVo.deviceType == ''">
                        case
                            when a.devicetype is null then '小计'
                            else a.devicetype
                        end as devicetype,
                    </when>
                </choose>
                count(1) ttl_eqs
            from
                _eq_ttl_net_info_tb a
            group by
                <choose>
                    <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType != null and imEqsNetworkingAndRemoteInfoVo.deviceType != ''">
                        rollup (a.company_name, a.group_name)
                    </when>
                    <otherwise>
                        rollup (a.company_name, a.group_name, a.devicetype)
                    </otherwise>
                </choose>
            )

        select
            case
                when a.company_name is null then '总计'
                else a.company_name
            end as company_name,
            case
                when a.group_name is null then '小计'
                else a.group_name
            end as group_name,
            <choose>
                <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType == null or imEqsNetworkingAndRemoteInfoVo.deviceType == ''">
                    case
                        when a.devicetype is null then '小计'
                        else a.devicetype
                    end as devicetype,
                </when>
            </choose>
            a.ttl_eqs,
            nvl(b.offline_eqs, 0) offline_eqs
        from  _eq_ttl_info_group_tb a
        left join _eq_offline_info_group_tb b
            on a.company_name = b.company_name and a.group_name = b.group_name
            <choose>
                <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType == null or imEqsNetworkingAndRemoteInfoVo.deviceType == ''">
                    and a.devicetype = b.devicetype
                </when>
            </choose>
        order by
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.companyOrder" />,
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.groupOrder" />
            <choose>
                <when test = "imEqsNetworkingAndRemoteInfoVo.deviceType == null or imEqsNetworkingAndRemoteInfoVo.deviceType == ''">
                    , <include refid="com.qtech.im.common.mapper.CommonSqlMapper.deviceTypeOrder" />
                </when>
            </choose>
    </select>

    <select id="selectEqNetworkingList" parameterType="map" resultMap="qtechImCommonInfoResult">
        WITH _eq_net_ok_tb AS (
            SELECT
                device_id,
                Remote_control
            FROM
                QT_MODEL_DDC.ALL_DEVICE_REMOTE_CONTROL_DETAIL
            WHERE receive_date > minutes_sub(now(), 5)
        ),

        _eq_ttl_tb AS (
            SELECT
                b.company_name,
                b.dep_name,
                b.group_name,
                a.device_id,
                a.device_m_id,
                a.devicetype,
                a.machine_no,
                c.pbox_id,
                e.receive_date
            FROM QT_MODEL_EMS.T_DEVICE_CALCGD1JH1U82GWWIONK a
            LEFT JOIN QT_MODEL_EMS.V_CODE_NAME b ON a.hierarchy_code = b.hierarchy_show_code
            LEFT JOIN QT_MODEL_EMS.T_PBOX_INFO c ON a.device_id = c.dev_id
            LEFT JOIN QT_MODEL_EMS.T_COLLECTOR_PROGRAM d ON c.collector_program_id = d.id
            LEFT JOIN QT_MODEL_DDC.ALL_DEVICE_REMOTE_CONTROL_DETAIL e ON a.device_id = e.device_id
            WHERE b.dep_name IN
                <foreach item="item" index="index" collection="deptNames" open="(" separator="," close=")">
                    #{item}
                </foreach>
            AND a.devicetype IN
                <foreach item="item" index="index" collection="deviceTypes" open="(" separator="," close=")">
                    #{item}
                </foreach>
        ),

        _eq_ttl_net_info_tb AS (
            SELECT
                company_name,
                dep_name,
                group_name,
                devicetype,
                device_m_id,
                machine_no,
                pbox_id,
                receive_date,
                Remote_control,
                net_status,
                CASE
                    WHEN (Remote_control REGEXP '^-?[0-9]+(\.[0-9]+)?$' AND net_status = 1 AND ((devicetype IN ('AA', 'DB', 'HM') AND Remote_control = '2')
                        OR (devicetype = 'WB' AND Remote_control = '5'))) THEN 1
                    WHEN (Remote_control REGEXP '^-?[0-9]+(\.[0-9]+)?$' AND net_status = 1 AND Remote_control = '999') THEN -1
                    ELSE 0
                END remote_status
            FROM (
                SELECT
                    a.company_name,
                    a.dep_name,
                    a.group_name,
                    a.devicetype,
                    a.device_m_id,
                    a.machine_no,
                    a.pbox_id,
                    a.receive_date,
                    b.Remote_control,
                    CASE
                        WHEN b.Remote_control IS NULL THEN 0
                        ELSE 1
                    END AS net_status
                FROM _eq_ttl_tb a
                LEFT JOIN _eq_net_ok_tb b ON a.device_id = b.device_id
            ) a
        )

        SELECT
            company_name,
            dep_name,
            group_name,
            devicetype as device_type,
            device_m_id,
            machine_no,
            pbox_id,
            receive_date,
            Remote_control,
            net_status,
            remote_status
        FROM
            _eq_ttl_net_info_tb
        <where>
            <if test="imEqsNetworkingAndRemoteInfoVo.factoryName != null and imEqsNetworkingAndRemoteInfoVo.factoryName != ''">
                AND company_name = #{imEqsNetworkingAndRemoteInfoVo.factoryName}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.groupName != null and imEqsNetworkingAndRemoteInfoVo.groupName != ''">
                AND group_name = #{imEqsNetworkingAndRemoteInfoVo.groupName}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.deviceType != null and imEqsNetworkingAndRemoteInfoVo.deviceType != ''">
                AND devicetype = #{imEqsNetworkingAndRemoteInfoVo.deviceType}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.eqId != null and imEqsNetworkingAndRemoteInfoVo.eqId != ''">
                AND device_m_id = #{imEqsNetworkingAndRemoteInfoVo.eqId}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.mcId != null and imEqsNetworkingAndRemoteInfoVo.mcId != ''">
                AND machine_no = #{imEqsNetworkingAndRemoteInfoVo.mcId}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.simId != null and imEqsNetworkingAndRemoteInfoVo.simId != ''">
                AND pbox_id = #{imEqsNetworkingAndRemoteInfoVo.simId}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.netStatus != null">
                AND net_status = #{imEqsNetworkingAndRemoteInfoVo.netStatus}
            </if>
            <if test="imEqsNetworkingAndRemoteInfoVo.remoteStatus != null">
                AND remote_status = #{imEqsNetworkingAndRemoteInfoVo.remoteStatus}
            </if>
        </where>
        ORDER BY
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.companyOrder" />,
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.groupOrder" />,
            <include refid="com.qtech.im.common.mapper.CommonSqlMapper.deviceTypeOrder" />, -- 添加一个明确的排序字段
            machine_no
    </select>
</mapper>
